name: Database Deployment

on:
  workflow_dispatch:
    inputs:
      environment:
        description: 'Environment to deploy to (prod, dev, qa, sandbox)'
        required: true
        default: 'dev'

jobs:
  deploy:
    runs-on: [self-hosted, uship-linux]
    environment: 
      name: ${{ github.event.inputs.environment }}

    steps:
      - name: Validate environment
        run: |
          echo "Selected environment: ${{ github.event.inputs.environment }}"
          case "${{ github.event.inputs.environment }}" in prod|dev|qa|sandbox)
          echo "Deploying to ${{ github.event.inputs.environment }}"
          ;;
          *)
          echo "Error: Invalid environment selected. Allowed values: prod, dev, qa, or sandbox"
          exit 1
          ;;
          esac
      
      - uses: actions/checkout@v3

      - name: Set up Java
        uses: actions/setup-java@v2
        with:
          java-version: 11
          distribution: 'adopt'

      - name: Set up Flyway
        run: |
          curl -o /tmp/flyway.tar.gz https://repo1.maven.org/maven2/org/flywaydb/flyway-commandline/7.14.1/flyway-commandline-7.14.1-linux-x64.tar.gz
          tar -xzf /tmp/flyway.tar.gz -C /tmp
          sudo mv /tmp/flyway-7.14.1 /opt/flyway
          sudo ln -s /opt/flyway/flyway /usr/local/bin/flyway

      - name: Run Flyway Migrations
        env:
          FLYWAY_URL: ${{ secrets.JDBC_URL }}
          FLYWAY_USER: ${{ secrets.DB_USER }}
          FLYWAY_PASSWORD: ${{ secrets.DB_PASS }}
        run: |
          echo "Running Flyway migrations..."
          sudo -E flyway baseline